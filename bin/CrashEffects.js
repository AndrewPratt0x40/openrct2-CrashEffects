/// Andrew Pratt 2021
var CrashEffects;(function(CrashEffects){var TrackElemType;(function(TrackElemType){TrackElemType.Flat=0;TrackElemType.EndStation=1;TrackElemType.BeginStation=2;TrackElemType.MiddleStation=3;TrackElemType.Up25=4;TrackElemType.Up60=5;TrackElemType.FlatToUp25=6;TrackElemType.Up25ToUp60=7;TrackElemType.Up60ToUp25=8;TrackElemType.Up25ToFlat=9;TrackElemType.Down25=10;TrackElemType.Down60=11;TrackElemType.FlatToDown25=12;TrackElemType.Down25ToDown60=13;TrackElemType.Down60ToDown25=14;TrackElemType.Down25ToFlat=15;TrackElemType.LeftQuarterTurn5Tiles=16;TrackElemType.RightQuarterTurn5Tiles=17;TrackElemType.FlatToLeftBank=18;TrackElemType.FlatToRightBank=19;TrackElemType.LeftBankToFlat=20;TrackElemType.RightBankToFlat=21;TrackElemType.BankedLeftQuarterTurn5Tiles=22;TrackElemType.BankedRightQuarterTurn5Tiles=23;TrackElemType.LeftBankToUp25=24;TrackElemType.RightBankToUp25=25;TrackElemType.Up25ToLeftBank=26;TrackElemType.Up25ToRightBank=27;TrackElemType.LeftBankToDown25=28;TrackElemType.RightBankToDown25=29;TrackElemType.Down25ToLeftBank=30;TrackElemType.Down25ToRightBank=31;TrackElemType.LeftBank=32;TrackElemType.RightBank=33;TrackElemType.LeftQuarterTurn5TilesUp25=34;TrackElemType.RightQuarterTurn5TilesUp25=35;TrackElemType.LeftQuarterTurn5TilesDown25=36;TrackElemType.RightQuarterTurn5TilesDown25=37;TrackElemType.SBendLeft=38;TrackElemType.SBendRight=39;TrackElemType.LeftVerticalLoop=40;TrackElemType.RightVerticalLoop=41;TrackElemType.LeftQuarterTurn3Tiles=42;TrackElemType.RightQuarterTurn3Tiles=43;TrackElemType.LeftBankedQuarterTurn3Tiles=44;TrackElemType.RightBankedQuarterTurn3Tiles=45;TrackElemType.LeftQuarterTurn3TilesUp25=46;TrackElemType.RightQuarterTurn3TilesUp25=47;TrackElemType.LeftQuarterTurn3TilesDown25=48;TrackElemType.RightQuarterTurn3TilesDown25=49;TrackElemType.LeftQuarterTurn1Tile=50;TrackElemType.RightQuarterTurn1Tile=51;TrackElemType.LeftTwistDownToUp=52;TrackElemType.RightTwistDownToUp=53;TrackElemType.LeftTwistUpToDown=54;TrackElemType.RightTwistUpToDown=55;TrackElemType.HalfLoopUp=56;TrackElemType.HalfLoopDown=57;TrackElemType.LeftCorkscrewUp=58;TrackElemType.RightCorkscrewUp=59;TrackElemType.LeftCorkscrewDown=60;TrackElemType.RightCorkscrewDown=61;TrackElemType.FlatToUp60=62;TrackElemType.Up60ToFlat=63;TrackElemType.FlatToDown60=64;TrackElemType.Down60ToFlat=65;TrackElemType.TowerBase=66;TrackElemType.TowerSection=67;TrackElemType.FlatCovered=68;TrackElemType.Up25Covered=69;TrackElemType.Up60Covered=70;TrackElemType.FlatToUp25Covered=71;TrackElemType.Up25ToUp60Covered=72;TrackElemType.Up60ToUp25Covered=73;TrackElemType.Up25ToFlatCovered=74;TrackElemType.Down25Covered=75;TrackElemType.Down60Covered=76;TrackElemType.FlatToDown25Covered=77;TrackElemType.Down25ToDown60Covered=78;TrackElemType.Down60ToDown25Covered=79;TrackElemType.Down25ToFlatCovered=80;TrackElemType.LeftQuarterTurn5TilesCovered=81;TrackElemType.RightQuarterTurn5TilesCovered=82;TrackElemType.SBendLeftCovered=83;TrackElemType.SBendRightCovered=84;TrackElemType.LeftQuarterTurn3TilesCovered=85;TrackElemType.RightQuarterTurn3TilesCovered=86;TrackElemType.LeftHalfBankedHelixUpSmall=87;TrackElemType.RightHalfBankedHelixUpSmall=88;TrackElemType.LeftHalfBankedHelixDownSmall=89;TrackElemType.RightHalfBankedHelixDownSmall=90;TrackElemType.LeftHalfBankedHelixUpLarge=91;TrackElemType.RightHalfBankedHelixUpLarge=92;TrackElemType.LeftHalfBankedHelixDownLarge=93;TrackElemType.RightHalfBankedHelixDownLarge=94;TrackElemType.LeftQuarterTurn1TileUp60=95;TrackElemType.RightQuarterTurn1TileUp60=96;TrackElemType.LeftQuarterTurn1TileDown60=97;TrackElemType.RightQuarterTurn1TileDown60=98;TrackElemType.Brakes=99;TrackElemType.RotationControlToggleAlias=100;TrackElemType.Booster=100;TrackElemType.Maze=101;TrackElemType.InvertedUp90ToFlatQuarterLoopAlias=101;TrackElemType.LeftQuarterBankedHelixLargeUp=102;TrackElemType.RightQuarterBankedHelixLargeUp=103;TrackElemType.LeftQuarterBankedHelixLargeDown=104;TrackElemType.RightQuarterBankedHelixLargeDown=105;TrackElemType.LeftQuarterHelixLargeUp=106;TrackElemType.RightQuarterHelixLargeUp=107;TrackElemType.LeftQuarterHelixLargeDown=108;TrackElemType.RightQuarterHelixLargeDown=109;TrackElemType.Up25LeftBanked=110;TrackElemType.Up25RightBanked=111;TrackElemType.Waterfall=112;TrackElemType.Rapids=113;TrackElemType.OnRidePhoto=114;TrackElemType.Down25LeftBanked=115;TrackElemType.Down25RightBanked=116;TrackElemType.Watersplash=117;TrackElemType.FlatToUp60LongBase=118;TrackElemType.Up60ToFlatLongBase=119;TrackElemType.Whirlpool=120;TrackElemType.Down60ToFlatLongBase=121;TrackElemType.FlatToDown60LongBase=122;TrackElemType.CableLiftHill=123;TrackElemType.ReverseFreefallSlope=124;TrackElemType.ReverseFreefallVertical=125;TrackElemType.Up90=126;TrackElemType.Down90=127;TrackElemType.Up60ToUp90=128;TrackElemType.Down90ToDown60=129;TrackElemType.Up90ToUp60=130;TrackElemType.Down60ToDown90=131;TrackElemType.BrakeForDrop=132;TrackElemType.LeftEighthToDiag=133;TrackElemType.RightEighthToDiag=134;TrackElemType.LeftEighthToOrthogonal=135;TrackElemType.RightEighthToOrthogonal=136;TrackElemType.LeftEighthBankToDiag=137;TrackElemType.RightEighthBankToDiag=138;TrackElemType.LeftEighthBankToOrthogonal=139;TrackElemType.RightEighthBankToOrthogonal=140;TrackElemType.DiagFlat=141;TrackElemType.DiagUp25=142;TrackElemType.DiagUp60=143;TrackElemType.DiagFlatToUp25=144;TrackElemType.DiagUp25ToUp60=145;TrackElemType.DiagUp60ToUp25=146;TrackElemType.DiagUp25ToFlat=147;TrackElemType.DiagDown25=148;TrackElemType.DiagDown60=149;TrackElemType.DiagFlatToDown25=150;TrackElemType.DiagDown25ToDown60=151;TrackElemType.DiagDown60ToDown25=152;TrackElemType.DiagDown25ToFlat=153;TrackElemType.DiagFlatToUp60=154;TrackElemType.DiagUp60ToFlat=155;TrackElemType.DiagFlatToDown60=156;TrackElemType.DiagDown60ToFlat=157;TrackElemType.DiagFlatToLeftBank=158;TrackElemType.DiagFlatToRightBank=159;TrackElemType.DiagLeftBankToFlat=160;TrackElemType.DiagRightBankToFlat=161;TrackElemType.DiagLeftBankToUp25=162;TrackElemType.DiagRightBankToUp25=163;TrackElemType.DiagUp25ToLeftBank=164;TrackElemType.DiagUp25ToRightBank=165;TrackElemType.DiagLeftBankToDown25=166;TrackElemType.DiagRightBankToDown25=167;TrackElemType.DiagDown25ToLeftBank=168;TrackElemType.DiagDown25ToRightBank=169;TrackElemType.DiagLeftBank=170;TrackElemType.DiagRightBank=171;TrackElemType.LogFlumeReverser=172;TrackElemType.SpinningTunnel=173;TrackElemType.LeftBarrelRollUpToDown=174;TrackElemType.RightBarrelRollUpToDown=175;TrackElemType.LeftBarrelRollDownToUp=176;TrackElemType.RightBarrelRollDownToUp=177;TrackElemType.LeftBankToLeftQuarterTurn3TilesUp25=178;TrackElemType.RightBankToRightQuarterTurn3TilesUp25=179;TrackElemType.LeftQuarterTurn3TilesDown25ToLeftBank=180;TrackElemType.RightQuarterTurn3TilesDown25ToRightBank=181;TrackElemType.PoweredLift=182;TrackElemType.LeftLargeHalfLoopUp=183;TrackElemType.RightLargeHalfLoopUp=184;TrackElemType.RightLargeHalfLoopDown=185;TrackElemType.LeftLargeHalfLoopDown=186;TrackElemType.LeftFlyerTwistUp=187;TrackElemType.RightFlyerTwistUp=188;TrackElemType.LeftFlyerTwistDown=189;TrackElemType.RightFlyerTwistDown=190;TrackElemType.FlyerHalfLoopUp=191;TrackElemType.FlyerHalfLoopDown=192;TrackElemType.LeftFlyerCorkscrewUp=193;TrackElemType.RightFlyerCorkscrewUp=194;TrackElemType.LeftFlyerCorkscrewDown=195;TrackElemType.RightFlyerCorkscrewDown=196;TrackElemType.HeartLineTransferUp=197;TrackElemType.HeartLineTransferDown=198;TrackElemType.LeftHeartLineRoll=199;TrackElemType.RightHeartLineRoll=200;TrackElemType.MinigolfHoleA=201;TrackElemType.MinigolfHoleB=202;TrackElemType.MinigolfHoleC=203;TrackElemType.MinigolfHoleD=204;TrackElemType.MinigolfHoleE=205;TrackElemType.MultiDimInvertedFlatToDown90QuarterLoop=206;TrackElemType.Up90ToInvertedFlatQuarterLoop=207;TrackElemType.InvertedFlatToDown90QuarterLoop=208;TrackElemType.LeftCurvedLiftHill=209;TrackElemType.RightCurvedLiftHill=210;TrackElemType.LeftReverser=211;TrackElemType.RightReverser=212;TrackElemType.AirThrustTopCap=213;TrackElemType.AirThrustVerticalDown=214;TrackElemType.AirThrustVerticalDownToLevel=215;TrackElemType.BlockBrakes=216;TrackElemType.LeftBankedQuarterTurn3TileUp25=217;TrackElemType.RightBankedQuarterTurn3TileUp25=218;TrackElemType.LeftBankedQuarterTurn3TileDown25=219;TrackElemType.RightBankedQuarterTurn3TileDown25=220;TrackElemType.LeftBankedQuarterTurn5TileUp25=221;TrackElemType.RightBankedQuarterTurn5TileUp25=222;TrackElemType.LeftBankedQuarterTurn5TileDown25=223;TrackElemType.RightBankedQuarterTurn5TileDown25=224;TrackElemType.Up25ToLeftBankedUp25=225;TrackElemType.Up25ToRightBankedUp25=226;TrackElemType.LeftBankedUp25ToUp25=227;TrackElemType.RightBankedUp25ToUp25=228;TrackElemType.Down25ToLeftBankedDown25=229;TrackElemType.Down25ToRightBankedDown25=230;TrackElemType.LeftBankedDown25ToDown25=231;TrackElemType.RightBankedDown25ToDown25=232;TrackElemType.LeftBankedFlatToLeftBankedUp25=233;TrackElemType.RightBankedFlatToRightBankedUp25=234;TrackElemType.LeftBankedUp25ToLeftBankedFlat=235;TrackElemType.RightBankedUp25ToRightBankedFlat=236;TrackElemType.LeftBankedFlatToLeftBankedDown25=237;TrackElemType.RightBankedFlatToRightBankedDown25=238;TrackElemType.LeftBankedDown25ToLeftBankedFlat=239;TrackElemType.RightBankedDown25ToRightBankedFlat=240;TrackElemType.FlatToLeftBankedUp25=241;TrackElemType.FlatToRightBankedUp25=242;TrackElemType.LeftBankedUp25ToFlat=243;TrackElemType.RightBankedUp25ToFlat=244;TrackElemType.FlatToLeftBankedDown25=245;TrackElemType.FlatToRightBankedDown25=246;TrackElemType.LeftBankedDown25ToFlat=247;TrackElemType.RightBankedDown25ToFlat=248;TrackElemType.LeftQuarterTurn1TileUp90=249;TrackElemType.RightQuarterTurn1TileUp90=250;TrackElemType.LeftQuarterTurn1TileDown90=251;TrackElemType.RightQuarterTurn1TileDown90=252;TrackElemType.MultiDimUp90ToInvertedFlatQuarterLoop=253;TrackElemType.MultiDimFlatToDown90QuarterLoop=254;TrackElemType.MultiDimInvertedUp90ToFlatQuarterLoop=255;TrackElemType.RotationControlToggle=256;TrackElemType.FlatTrack1x4A=257;TrackElemType.FlatTrack2x2=258;TrackElemType.FlatTrack4x4=259;TrackElemType.FlatTrack2x4=260;TrackElemType.FlatTrack1x5=261;TrackElemType.FlatTrack1x1A=262;TrackElemType.FlatTrack1x4B=263;TrackElemType.FlatTrack1x1B=264;TrackElemType.FlatTrack1x4C=265;TrackElemType.FlatTrack3x3=266;TrackElemType.Count=267;TrackElemType.None=65535;TrackElemType.FlatTrack1x4A_Alias=95;TrackElemType.FlatTrack2x2_Alias=110;TrackElemType.FlatTrack4x4_Alias=111;TrackElemType.FlatTrack2x4_Alias=115;TrackElemType.FlatTrack1x5_Alias=116;TrackElemType.FlatTrack1x1A_Alias=118;TrackElemType.FlatTrack1x4B_Alias=119;TrackElemType.FlatTrack1x1B_Alias=121;TrackElemType.FlatTrack1x4C_Alias=122;TrackElemType.FlatTrack3x3_Alias=123})(TrackElemType=CrashEffects.TrackElemType||(CrashEffects.TrackElemType={}))})(CrashEffects||(CrashEffects={}));var ESurfaceStyles;(function(ESurfaceStyles){ESurfaceStyles[ESurfaceStyles["GRASS"]=0]="GRASS";ESurfaceStyles[ESurfaceStyles["SAND"]=1]="SAND";ESurfaceStyles[ESurfaceStyles["DIRT"]=2]="DIRT";ESurfaceStyles[ESurfaceStyles["ROCK"]=3]="ROCK";ESurfaceStyles[ESurfaceStyles["MARTIAN"]=4]="MARTIAN";ESurfaceStyles[ESurfaceStyles["CHECKERBOARD"]=5]="CHECKERBOARD";ESurfaceStyles[ESurfaceStyles["GRASS_CLUMPS"]=6]="GRASS_CLUMPS";ESurfaceStyles[ESurfaceStyles["ICE"]=7]="ICE";ESurfaceStyles[ESurfaceStyles["GRID_RED"]=8]="GRID_RED";ESurfaceStyles[ESurfaceStyles["GRID_YELLOW"]=9]="GRID_YELLOW";ESurfaceStyles[ESurfaceStyles["GRID_PURPLE"]=10]="GRID_PURPLE";ESurfaceStyles[ESurfaceStyles["GRID_GREEN"]=11]="GRID_GREEN";ESurfaceStyles[ESurfaceStyles["SAND_RED"]=12]="SAND_RED";ESurfaceStyles[ESurfaceStyles["SAND_BROWN"]=13]="SAND_BROWN"})(ESurfaceStyles||(ESurfaceStyles={}));var CrashEffects;(function(CrashEffects){var PI2=Math.PI*2;var DMG_MINOR=.334;var DMG_MEDIUM=.667;function vec3Subtract(minuend,subtrahend){return{x:minuend.x-subtrahend.x,y:minuend.y-subtrahend.y,z:minuend.z-subtrahend.z}}function vec3DistSqr(from,to){var dx=to.x-from.x;var dy=to.y-from.y;var dz=to.z-from.z;return dx*dx+dy*dy+dz*dz}function vec3Dist(from,to){return Math.sqrt(vec3DistSqr(from,to))}function easyMsg(msg){park.postMessage({type:"award",text:msg})}function asTileCoord(v){return{x:v.x*.03125,y:v.y*.03125,z:v.z*.03125}}function offsetBy2DPolar(pos,r,theta){return{x:pos.x+r*Math.cos(theta),y:pos.y+r*Math.sin(theta),z:pos.z}}function getEntPos(ent){return{x:ent.x,y:ent.y,z:ent.z}}function isTilePosInsideMap(pos){return pos.x>0&&pos.x<=map.size.x&&pos.y>0&&pos.y<=map.size.y}function trackTypeIs1x1(trackType){return trackType>=0&&trackType<CrashEffects.TrackElemType.Count&&(trackType<=CrashEffects.TrackElemType.Down25ToFlat||trackType>=CrashEffects.TrackElemType.FlatToLeftBank&&trackType<=CrashEffects.TrackElemType.RightBankToFlat||trackType>=CrashEffects.TrackElemType.LeftBankToUp25&&trackType<=CrashEffects.TrackElemType.RightBank||trackType>=CrashEffects.TrackElemType.LeftQuarterTurn1Tile&&trackType<=CrashEffects.TrackElemType.RightQuarterTurn1Tile||trackType>=CrashEffects.TrackElemType.FlatToUp60&&trackType<=CrashEffects.TrackElemType.Down60ToFlat||trackType>=CrashEffects.TrackElemType.LeftQuarterTurn1TileUp60&&trackType<=CrashEffects.TrackElemType.Maze||trackType>=CrashEffects.TrackElemType.Up25LeftBanked&&trackType<=CrashEffects.TrackElemType.Down25RightBanked||trackType>=CrashEffects.TrackElemType.FlatToUp60LongBase&&trackType<=CrashEffects.TrackElemType.FlatToDown60LongBase||trackType>=CrashEffects.TrackElemType.Up90&&trackType<=CrashEffects.TrackElemType.BrakeForDrop||trackType>=CrashEffects.TrackElemType.LogFlumeReverser&&trackType<=CrashEffects.TrackElemType.SpinningTunnel||trackType>=CrashEffects.TrackElemType.Up25ToLeftBankedUp25&&trackType<=CrashEffects.TrackElemType.RightQuarterTurn1TileDown90||trackType>=CrashEffects.TrackElemType.Up25ToLeftBankedUp25&&trackType<=CrashEffects.TrackElemType.RightQuarterTurn1TileDown90||trackType==CrashEffects.TrackElemType.RotationControlToggle||trackType==CrashEffects.TrackElemType.FlatTrack1x1A||trackType==CrashEffects.TrackElemType.FlatTrack1x1B||trackType==CrashEffects.TrackElemType.FlatTrack1x1A_Alias||trackType==CrashEffects.TrackElemType.FlatTrack1x1B_Alias)}function trackElemIs1x1(elem){if(elem.sequence!=0)return false;return trackTypeIs1x1(elem.trackType)}function convertSurfaceElementToRubble(elem,dmgStrength){if(dmgStrength<=DMG_MINOR){switch(elem.surfaceStyle){case ESurfaceStyles.GRASS:elem.surfaceStyle=ESurfaceStyles.GRASS_CLUMPS;break;case ESurfaceStyles.SAND:elem.surfaceStyle=ESurfaceStyles.SAND_BROWN;break;case ESurfaceStyles.ICE:elem.surfaceStyle=ESurfaceStyles.DIRT;break}}else if(dmgStrength<=DMG_MEDIUM){if(elem.surfaceStyle!=ESurfaceStyles.ROCK)elem.surfaceStyle=ESurfaceStyles.DIRT}else elem.surfaceStyle=ESurfaceStyles.ROCK}function damageSurfaceTileElement(elem,elemIndex,dmgStrength){convertSurfaceElementToRubble(elem,dmgStrength)}function breakFootpathAdditions(elem){if(!elem.isQueue&&elem.addition!=null)elem.isAdditionBroken=true}function destroyFootpath(elemIndex,tile){tile.removeElement(elemIndex)}function damageFootpath(elem,elemIndex,tile,dmgStrength){if(dmgStrength<=DMG_MEDIUM)breakFootpathAdditions(elem);else destroyFootpath(elemIndex,tile)}function destroySmallScenery(elemIndex,tile){tile.removeElement(elemIndex)}function damageSmallScenery(elem,elemIndex,tile,dmgStrength){if(elem.quadrant!=0||dmgStrength>DMG_MINOR)destroySmallScenery(elemIndex,tile)}function destroyTrackElement(elemIndex,tile){tile.removeElement(elemIndex)}function damageTrack(elem,elemIndex,tile,dmgStrength){if(dmgStrength>DMG_MEDIUM&&trackElemIs1x1(elem))destroyTrackElement(elemIndex,tile)}function destroyWall(elemIndex,tile){tile.removeElement(elemIndex)}function damageWall(elem,elemIndex,tile,dmgStrength){if(dmgStrength>DMG_MINOR)destroyWall(elemIndex,tile)}function damageTileElement(elem,elemIndex,tile,dmgStrength){switch(elem.type){case"surface":damageSurfaceTileElement(elem,elemIndex,dmgStrength);break;case"footpath":damageFootpath(elem,elemIndex,tile,dmgStrength);break;case"small_scenery":damageSmallScenery(elem,elemIndex,tile,dmgStrength);break;case"track":damageTrack(elem,elemIndex,tile,dmgStrength);break;case"wall":damageWall(elem,elemIndex,tile,dmgStrength)}}function createRubbleAtTileElem(elemIndex,tile,tilePos,rubbleCenter,affectRadius){var elem=tile.getElement(elemIndex);var dist=vec3Dist({x:tilePos.x,y:tilePos.y,z:elem.baseHeight*.25},rubbleCenter);if(dist<=affectRadius){var dmgStrength=1-dist/affectRadius;if(dmgStrength>0)damageTileElement(elem,elemIndex,tile,dmgStrength)}}function createRubbleAtTile(tilePos,rubbleCenter,affectRadius){var tile=map.getTile(tilePos.x,tilePos.y);for(var i=0;i<tile.numElements;++i){createRubbleAtTileElem(i,tile,tilePos,rubbleCenter,affectRadius)}}function createRubbleAt(pos,affectRadius){for(var r=0;r<affectRadius;++r){var thetaStep=Math.PI/Math.max(1,4*r);for(var theta=0;theta<PI2;theta+=thetaStep){var tilePos=offsetBy2DPolar(pos,r,theta);if(isTilePosInsideMap(tilePos))createRubbleAtTile(tilePos,pos,affectRadius)}}}function onCrash(e){createRubbleAt(asTileCoord(getEntPos(map.getEntity(e.id))),3)}function init(){context.subscribe("vehicle.crash",onCrash)}CrashEffects.CrashEffectsPluginMetadata={name:"Crash Effects",version:"1.4",licence:"https://github.com/andrewpratt64/openrct2-CrashEffects/blob/main/LICENSE.txt",authors:["Andrew Pratt"],type:"remote",main:function(){init()}}})(CrashEffects||(CrashEffects={}));registerPlugin(CrashEffects.CrashEffectsPluginMetadata);